<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listado Maestro de Documentación v3</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Librerías para exportación -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Paleta de colores corporativa */
        :root {
            --corporate-blue: #44546A;
            --corporate-blue-dark: #354254;
            --text-on-corporate: #FFFFFF;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Estilos para componentes con colores corporativos */
        .bg-corporate { background-color: var(--corporate-blue); }
        .hover\:bg-corporate-dark:hover { background-color: var(--corporate-blue-dark); }
        .text-corporate { color: var(--corporate-blue); }
        .ring-corporate:focus { ring-color: var(--corporate-blue); }
        .border-corporate { border-color: var(--corporate-blue); }

        /* Celdas editables */
        [contenteditable="true"] {
            outline: 2px dashed transparent;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 4px;
        }
        [contenteditable="true"]:hover { background-color: #e0f2fe; }
        [contenteditable="true"]:focus {
            outline: 2px solid var(--corporate-blue);
            background-color: white;
            box-shadow: 0 0 0 3px rgba(68, 84, 106, 0.2);
        }

        /* Semáforo de filas */
        .semaphore-green { background-color: rgba(34, 197, 94, 0.1); }
        .semaphore-red { background-color: rgba(239, 68, 68, 0.1); }
        
        /* Animaciones para modales y notificaciones */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideInUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-backdrop { animation: fadeIn 0.2s ease-out forwards; }
        .modal-content { animation: scaleIn 0.2s ease-out forwards; }
        .toast { animation: slideInUp 0.4s ease-out forwards, fadeOut 0.4s ease-in 3.6s forwards; }
    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="text-gray-800">
    <div id="loader" class="p-4 text-center">Verificando acceso...</div>
    <div id="page-content" class="hidden">

    <!-- Barra de navegación -->
    <nav class="bg-corporate shadow-lg">
        <div class="container mx-auto px-4 md:px-6">
            <div class="flex items-center justify-between h-16">

                <div class="flex items-center">
                    <a href="index.html" class="flex items-center text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-terminal mr-3 text-xl"></i>
                        <span class="font-bold text-lg">Proyecto Barack</span>
                    </a>

                    <div class="hidden md:flex items-center ml-6">

                         <a href="index.html" class="text-gray-300 hover:bg-corporate-dark hover:text-white px-3 py-2 rounded-md text-sm font-medium">Inicio</a>

                         <a id="linkListado" href="#" class="bg-gray-700/50 text-white px-3 py-2 rounded-md text-sm font-medium ml-4" aria-current="page">Listado Maestro</a>

                         <a id="linkAmfe" href="#" class="text-gray-300 hover:bg-corporate-dark hover:text-white px-3 py-2 rounded-md text-sm font-medium ml-4">Análisis AMFE</a>

                         <a href="sinoptico-producto.html" class="text-gray-300 hover:bg-corporate-dark hover:text-white px-3 py-2 rounded-md text-sm font-medium ml-4">Sinóptico Producto</a>

                         </div>
                </div>

                <div class="flex items-center">
                     <span id="currentUserDisplay" class="text-gray-300 text-sm mr-4 hidden md:block">Usuario: admin.user</span>
                     <button id="logoutButton" class="text-gray-300 hover:bg-corporate-dark hover:text-white px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-sign-out-alt mr-1"></i>
                        <span class="hidden sm:inline">Cerrar Sesión</span>
                     </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Contenedor principal -->
    <div class="container mx-auto p-4 md:p-6">
        
        <!-- Cabecera -->
        <header class="mb-6 pb-4 border-b border-gray-300">
            <h1 class="text-3xl md:text-4xl font-bold text-corporate">Listado Maestro</h1>
            <p class="text-gray-500 mt-1">Panel central para el control de revisiones y dependencias de documentación.</p>
        </header>

        <!-- Panel de Acciones y Búsqueda -->
        <div class="mb-6 p-4 bg-white rounded-lg shadow-sm">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                <div class="flex flex-wrap gap-3">
                    <button id="addProductBtn" class="bg-corporate hover:bg-corporate-dark text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-plus mr-2"></i>Nuevo Producto
                    </button>
                    <button id="manageColsBtn" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-columns mr-2"></i>Gestionar Columnas y Dependencias
                    </button>
                </div>
                <div class="relative w-full">
                    <input type="text" id="searchInput" class="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-corporate focus:border-corporate" placeholder="Buscar producto...">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
            <div class="flex flex-wrap gap-3 mt-4 pt-4 border-t border-gray-200">
                 <button id="showHistoryBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-colors text-sm">
                    <i class="fas fa-history mr-2"></i>Ver Historial
                </button>
                <button id="exportExcelBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors text-sm">
                    <i class="fas fa-file-excel mr-2"></i>Exportar a Excel
                </button>
                <button id="exportPdfBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors text-sm">
                    <i class="fas fa-file-pdf mr-2"></i>Exportar a PDF
                </button>
            </div>
        </div>
        
        <!-- Info de Dependencias -->
        <div id="dependency-info" class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800"></div>

        <!-- Tabla Principal -->
        <div class="bg-white rounded-lg shadow-md overflow-x-auto">
            <table class="w-full text-left" id="main-table">
                <thead class="bg-gray-50 border-b border-gray-200 text-xs text-gray-500 uppercase tracking-wider">
                    <!-- Cabeceras dinámicas -->
                </thead>
                <tbody id="maestro-table-body" class="divide-y divide-gray-200">
                    <!-- Filas dinámicas -->
                </tbody>
            </table>
            <div id="no-results" class="hidden text-center p-8 text-gray-500">
                <i class="fas fa-search fa-2x mb-2"></i>
                <p>No se encontraron productos.</p>
            </div>
        </div>
    </div>

    <!-- Contenedor para Modales y Notificaciones -->
    <div id="modal-container"></div>
    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            // --- ESTADO Y CONFIGURACIÓN ---
            state: {
                products: [],
                history: [],
                docKeys: [],
                dependencies: {} // Objeto para { triggerKey: [dependentKey1, dependentKey2] }
            },
            currentUser: 'admin.user',

            // --- REFERENCIAS AL DOM ---
            dom: {
                tableBody: document.getElementById('maestro-table-body'),
                tableHead: document.querySelector('#main-table thead'),
                addProductBtn: document.getElementById('addProductBtn'),
                manageColsBtn: document.getElementById('manageColsBtn'),
                showHistoryBtn: document.getElementById('showHistoryBtn'),
                exportExcelBtn: document.getElementById('exportExcelBtn'),
                exportPdfBtn: document.getElementById('exportPdfBtn'),
                searchInput: document.getElementById('searchInput'),
                modalContainer: document.getElementById('modal-container'),
                toastContainer: document.getElementById('toast-container'),
                noResults: document.getElementById('no-results'),
                dependencyInfo: document.getElementById('dependency-info')
            },

            // --- PERSISTENCIA ---
            storage: {
                save() {
                    localStorage.setItem('maestroState_v3', JSON.stringify(App.state));
                },
                load() {
                    const storedState = localStorage.getItem('maestroState_v3');
                    if (storedState) {
                        App.state = JSON.parse(storedState);
                        // Asegurar que las dependencias existan si se carga una versión vieja
                        if (!App.state.dependencies) {
                           App.state.dependencies = { 'Flujograma': ['AMFE', 'Hoja de Operaciones'] };
                        }
                    } else {
                        // Datos de ejemplo para el primer uso
                        App.state.docKeys = ['Flujograma', 'AMFE', 'Hoja de Operaciones', 'Plano'];
                        App.state.dependencies = { 'Flujograma': ['AMFE', 'Hoja de Operaciones'] };
                        App.state.products = [
                            { id: 1, name: 'Producto A-100', notificado: true, data: { 'Flujograma': { rev: '05', link: 'ruta/a/flujo' }, 'AMFE': { rev: '03', link: 'ruta/a/amfe' }, 'Hoja de Operaciones': { rev: '09', link: 'ruta/a/ho' }, 'Plano': {rev: 'C', link: 'ruta/a/plano'}}},
                            { id: 2, name: 'Componente X-01', notificado: false, data: { 'Flujograma': { rev: '11', link: 'ruta/x/flujo' }, 'AMFE': { rev: '', link: '' }, 'Hoja de Operaciones': { rev: '', link: '' }, 'Plano': {rev: 'A', link: 'ruta/x/plano'}}}
                        ];
                    }
                }
            },

            // --- LÓGICA DE NEGOCIO ---
            logic: {
                logHistory(productId, docKey, field, oldValue, newValue) {
                    const productName = App.state.products.find(p => p.id === productId)?.name || 'N/A';
                    App.state.history.unshift({
                        timestamp: new Date().toLocaleString('es-AR'),
                        usuario: App.currentUser,
                        producto: productName,
                        documento: `${docKey} (${field})`,
                        antes: oldValue,
                        despues: newValue
                    });
                },

                checkAndResolveSemaphore(productId) {
                    const product = App.state.products.find(p => p.id === productId);
                    if (!product) return;
                    product.notificado = App.state.docKeys.every(key => product.data[key] && product.data[key].rev);
                },

                addNewProduct(name) {
                    const newId = App.state.products.length > 0 ? Math.max(...App.state.products.map(p => p.id)) + 1 : 1;
                    const newProductData = {};
                    App.state.docKeys.forEach(key => { newProductData[key] = { rev: '', link: '' }; });
                    
                    App.state.products.push({ id: newId, name: name.trim(), notificado: false, data: newProductData });
                    this.logHistory(newId, 'Producto', 'creado', '', name.trim());
                    App.storage.save();
                    App.init();
                    App.ui.showToast('Producto añadido correctamente', 'success');
                },
                
                deleteProduct(productId) {
                    const product = App.state.products.find(p => p.id === productId);
                    if(product) {
                        App.state.products = App.state.products.filter(p => p.id !== productId);
                        this.logHistory(productId, 'Producto', 'eliminado', product.name, 'N/A');
                        App.storage.save();
                        App.render.table();
                        App.ui.showToast('Producto eliminado', 'error');
                    }
                },

                handleCellEdit(cell, productId, docKey, field) {
                    const product = App.state.products.find(p => p.id === productId);
                    if (!product) return;

                    const oldValue = product.data[docKey][field];
                    const newValue = cell.innerText.trim();

                    if (oldValue !== newValue) {
                        product.data[docKey][field] = newValue;
                        this.logHistory(productId, docKey, field, oldValue, newValue);

                        // Lógica de dependencias
                        const dependents = App.state.dependencies[docKey];
                        if (dependents && field === 'rev') {
                            dependents.forEach(dependentKey => {
                                if (product.data[dependentKey]) {
                                    const depOldRev = product.data[dependentKey].rev;
                                    const depOldLink = product.data[dependentKey].link;
                                    if(depOldRev) this.logHistory(productId, dependentKey, 'rev', depOldRev, '');
                                    if(depOldLink) this.logHistory(productId, dependentKey, 'link', depOldLink, '');
                                    product.data[dependentKey].rev = '';
                                    product.data[dependentKey].link = '';
                                }
                            });
                        }

                        this.checkAndResolveSemaphore(productId);
                        App.storage.save();
                        App.render.table(App.dom.searchInput.value);
                    }
                }
            },

            // --- RENDERIZADO Y UI ---
            render: {
                table(filter = '') {
                    this.headers();
                    this.dependencyInfo();
                    const filteredProducts = App.state.products.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()));
                    App.dom.tableBody.innerHTML = '';
                    App.dom.noResults.classList.toggle('hidden', filteredProducts.length > 0);
                    
                    filteredProducts.forEach(product => {
                        const row = document.createElement('tr');
                        row.className = `transition-colors duration-300 ${product.notificado ? 'semaphore-green' : 'semaphore-red'}`;
                        let cells = `<td class="p-3 font-medium text-gray-900">${product.name}</td>`;
                        App.state.docKeys.forEach(key => {
                            const docData = product.data[key] || { rev: '', link: '' };
                            // El link usa `file://` para compatibilidad con Electron en redes locales.
                            // Podría no funcionar en navegadores web por seguridad.
                            const linkContent = docData.link ? `<a href="file://${docData.link}" target="_blank" class="text-blue-600 hover:underline">${docData.link}</a>` : '';
                            cells += `
                                <td class="p-1 text-center" data-product-id="${product.id}" data-doc-key="${key}" data-field="rev" contenteditable="true">${docData.rev}</td>
                                <td class="p-1 text-center" data-product-id="${product.id}" data-doc-key="${key}" data-field="link" contenteditable="true">${docData.link}</td>
                            `;
                        });
                        cells += `
                            <td class="p-3 text-center">
                                <button class="text-gray-400 hover:text-red-600 delete-btn" data-product-id="${product.id}"><i class="fas fa-trash-alt"></i></button>
                            </td>`;
                        row.innerHTML = cells;
                        App.dom.tableBody.appendChild(row);
                    });
                },
                headers() {
                    App.dom.tableHead.innerHTML = `
                        <tr>
                            <th rowspan="2" class="p-3 align-middle">Producto</th>
                            ${App.state.docKeys.map(key => `<th colspan="2" class="p-3 text-center border-l">${key}</th>`).join('')}
                            <th rowspan="2" class="p-3 align-middle text-center border-l">Acciones</th>
                        </tr>
                        <tr class="text-gray-400">
                            ${App.state.docKeys.map(() => `<th class="p-2 font-medium text-center border-l">Rev.</th><th class="p-2 font-medium text-center">Link</th>`).join('')}
                        </tr>
                    `;
                },
                dependencyInfo() {
                    let infoHtml = '<strong>Reglas de Dependencia Activas:</strong><ul class="list-disc list-inside mt-1">';
                    const activeRules = Object.entries(App.state.dependencies).filter(([_, deps]) => deps.length > 0);
                    if (activeRules.length === 0) {
                        infoHtml += '<li>No hay dependencias configuradas.</li>';
                    } else {
                        activeRules.forEach(([trigger, dependents]) => {
                            infoHtml += `<li>Al cambiar la revisión de <strong>${trigger}</strong>, se requerirá actualizar: <strong>${dependents.join(', ')}</strong>.</li>`;
                        });
                    }
                    infoHtml += '</ul>';
                    App.dom.dependencyInfo.innerHTML = infoHtml;
                }
            },
            
            ui: {
                showToast(message, type = 'info') {
                    const colors = { info: 'bg-corporate', success: 'bg-green-600', error: 'bg-red-600' };
                    const toast = document.createElement('div');
                    toast.className = `toast text-white py-3 px-5 rounded-lg shadow-xl ${colors[type]}`;
                    toast.textContent = message;
                    App.dom.toastContainer.appendChild(toast);
                    setTimeout(() => toast.remove(), 4000);
                },

                showModal(title, content, onConfirm, confirmText = 'Confirmar', maxWidth = 'max-w-md') {
                    const modalId = `modal-${Date.now()}`;
                    const modalHTML = `
                        <div id="${modalId}" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
                            <div class="modal-content bg-white rounded-lg shadow-xl w-full ${maxWidth} flex flex-col">
                                <div class="p-5 border-b bg-gray-50 rounded-t-lg flex justify-between items-center">
                                    <h3 class="text-xl font-semibold text-corporate">${title}</h3>
                                    <button class="close-modal-btn text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
                                </div>
                                <div class="p-5">${content}</div>
                                <div class="p-4 bg-gray-50 border-t flex justify-end gap-3 rounded-b-lg">
                                    <button class="cancel-modal-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                                    <button class="confirm-modal-btn bg-corporate hover:bg-corporate-dark text-white font-bold py-2 px-4 rounded-lg">${confirmText}</button>
                                </div>
                            </div>
                        </div>`;
                    App.dom.modalContainer.innerHTML = modalHTML;
                    
                    const modal = document.getElementById(modalId);
                    const form = modal.querySelector('form');

                    const closeModal = () => modal.remove();

                    modal.querySelector('.close-modal-btn').onclick = closeModal;
                    modal.querySelector('.cancel-modal-btn').onclick = closeModal;
                    modal.querySelector('.confirm-modal-btn').onclick = () => { if (onConfirm(modal)) closeModal(); };
                    if (form) form.onsubmit = (e) => { e.preventDefault(); if (onConfirm(modal)) closeModal(); }
                }
            },

            // --- MANEJADORES DE EVENTOS PRINCIPALES ---
            init() {
                this.storage.load();
                this.render.table();
                
                this.dom.addProductBtn.onclick = () => {
                    const content = `<form><label for="productName" class="block text-sm font-medium text-gray-700">Nombre del Producto</label><input type="text" id="productName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-corporate" required autofocus></form>`;
                    App.ui.showModal('Añadir Nuevo Producto', content, (modal) => {
                        const input = modal.querySelector('#productName');
                        if (input.value.trim()) { App.logic.addNewProduct(input.value); return true; }
                        return false;
                    }, 'Añadir');
                };
                
                this.dom.manageColsBtn.onclick = () => {
                    let content = '<div class="space-y-4">';
                    // Sección de Columnas
                    content += '<div><h4 class="font-semibold mb-2">Columnas Actuales</h4><div id="cols-list" class="space-y-2">';
                    App.state.docKeys.forEach(key => {
                        content += `<div class="flex items-center justify-between p-2 bg-gray-100 rounded-md"><span>${key}</span><button class="delete-col-btn text-red-500 hover:text-red-700 font-bold text-xl" data-key="${key}">&times;</button></div>`;
                    });
                    content += '</div></div>';
                    // Sección de Dependencias
                    content += '<div><h4 class="font-semibold mb-2">Reglas de Dependencia</h4><p class="text-xs text-gray-500 mb-2">Marca qué columnas se deben actualizar cuando cambia la revisión de una columna "disparadora".</p><div class="space-y-3">';
                     App.state.docKeys.forEach(triggerKey => {
                        content += `<div class="p-3 border rounded-md"><strong class="font-medium">${triggerKey}</strong> <span class="text-gray-500 text-xs">(disparador)</span><div class="grid grid-cols-2 gap-2 mt-2">`;
                        App.state.docKeys.forEach(dependentKey => {
                            if (triggerKey !== dependentKey) {
                                const isChecked = App.state.dependencies[triggerKey]?.includes(dependentKey) || false;
                                content += `<div><label class="flex items-center text-sm"><input type="checkbox" class="dependency-cb form-checkbox rounded text-corporate" data-trigger="${triggerKey}" data-dependent="${dependentKey}" ${isChecked ? 'checked' : ''}> <span class="ml-2">${dependentKey}</span></label></div>`;
                            }
                        });
                        content += '</div></div>';
                    });
                    content += '</div></div>';
                    // Formulario para añadir nueva columna
                    content += `<form class="mt-4 flex gap-2"><input type="text" id="newColName" placeholder="Nombre nueva columna" class="flex-grow border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-corporate"><button type="submit" class="bg-corporate text-white px-4 rounded-md hover:bg-corporate-dark">Añadir</button></form>`;
                    content += '</div>';

                    App.ui.showModal('Gestionar Columnas y Dependencias', content, () => { App.init(); return true; }, 'Cerrar y Guardar', 'max-w-2xl');
                    
                    const modal = App.dom.modalContainer.querySelector('.modal-backdrop');
                    
                    // Lógica para el modal
                    modal.querySelector('form').onsubmit = e => {
                        e.preventDefault();
                        const input = modal.querySelector('#newColName');
                        const newColName = input.value.trim();
                        if (newColName && !App.state.docKeys.includes(newColName)) {
                            App.state.docKeys.push(newColName);
                            App.state.dependencies[newColName] = [];
                            App.state.products.forEach(p => p.data[newColName] = { rev: '', link: '' });
                            input.value = '';
                            App.ui.showToast(`Columna "${newColName}" añadida`, 'success');
                            this.dom.manageColsBtn.click(); // Re-abre el modal para reflejar el cambio
                        }
                    };

                    modal.querySelectorAll('.delete-col-btn').forEach(btn => {
                        btn.onclick = () => {
                            const keyToDelete = btn.dataset.key;
                            if (confirm(`¿Seguro que quieres eliminar la columna "${keyToDelete}" y todos sus datos?`)) {
                                App.state.docKeys = App.state.docKeys.filter(k => k !== keyToDelete);
                                delete App.state.dependencies[keyToDelete];
                                for (const key in App.state.dependencies) {
                                    App.state.dependencies[key] = App.state.dependencies[key].filter(d => d !== keyToDelete);
                                }
                                App.state.products.forEach(p => delete p.data[keyToDelete]);
                                this.dom.manageColsBtn.click();
                            }
                        }
                    });

                    modal.querySelectorAll('.dependency-cb').forEach(cb => {
                        cb.onchange = () => {
                            const trigger = cb.dataset.trigger;
                            const dependent = cb.dataset.dependent;
                            if (!App.state.dependencies[trigger]) App.state.dependencies[trigger] = [];
                            
                            if (cb.checked) {
                                App.state.dependencies[trigger].push(dependent);
                            } else {
                                App.state.dependencies[trigger] = App.state.dependencies[trigger].filter(d => d !== dependent);
                            }
                            App.storage.save();
                        };
                    });
                };
                
                this.dom.showHistoryBtn.onclick = () => {
                    let historyHtml = App.state.history.length ? App.state.history.map(h => `
                        <tr class="text-sm border-b border-gray-200">
                            <td class="p-3">${h.timestamp}</td>
                            <td class="p-3">${h.usuario}</td>
                            <td class="p-3 font-semibold">${h.producto}</td>
                            <td class="p-3">${h.documento}</td>
                            <td class="p-3 text-red-600">${h.antes}</td>
                            <td class="p-3 text-green-600">${h.despues}</td>
                        </tr>`).join('') : `<tr><td colspan="6" class="p-8 text-center text-gray-500">No hay historial.</td></tr>`;
                    
                    const content = `<div class="max-h-[60vh] overflow-y-auto"><table class="w-full text-left"><thead class="text-xs uppercase bg-gray-100"><tr class="border-b-2 border-gray-300"><th class="p-3">Fecha</th><th>Usuario</th><th>Producto</th><th>Documento</th><th>Valor Anterior</th><th>Valor Nuevo</th></tr></thead><tbody>${historyHtml}</tbody></table></div>`;
                    App.ui.showModal('Historial de Cambios', content, () => true, 'Cerrar', 'max-w-4xl');
                };

                this.dom.tableBody.addEventListener('focusin', e => {
                    const cell = e.target;
                    if (cell.isContentEditable) {
                        cell.addEventListener('blur', () => { App.logic.handleCellEdit(cell, parseInt(cell.dataset.productId), cell.dataset.docKey, cell.dataset.field); }, { once: true });
                    }
                });

                this.dom.tableBody.addEventListener('click', e => {
                    const deleteBtn = e.target.closest('.delete-btn');
                    if (deleteBtn) {
                        const productId = parseInt(deleteBtn.dataset.productId);
                        const productName = App.state.products.find(p => p.id === productId)?.name;
                        const content = `<p>¿Estás seguro de que quieres eliminar el producto <strong>"${productName}"</strong>? Esta acción no se puede deshacer.</p>`;
                        App.ui.showModal('Confirmar Eliminación', content, () => { App.logic.deleteProduct(productId); return true; }, 'Eliminar');
                    }
                });

                this.dom.searchInput.onkeyup = e => this.render.table(e.target.value);
                this.dom.exportExcelBtn.onclick = () => App.export.toExcel();
                this.dom.exportPdfBtn.onclick = () => App.export.toPdf();

                //Export functions
                App.export = {
                    toExcel() {
                        const dataMaestro = App.state.products.map(p => {
                            const row = { Estado: p.notificado ? 'Al día' : 'Pendiente', Producto: p.name };
                            App.state.docKeys.forEach(key => {
                                row[`${key} Rev.`] = p.data[key]?.rev || '';
                                row[`${key} Link`] = p.data[key]?.link || '';
                            });
                            return row;
                        });
                        const wsMaestro = XLSX.utils.json_to_sheet(dataMaestro);
                        const wsHistory = XLSX.utils.json_to_sheet(App.state.history);

                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, wsMaestro, "Listado Maestro");
                        XLSX.utils.book_append_sheet(wb, wsHistory, "Historial");
                        
                        XLSX.writeFile(wb, "ListadoMaestro.xlsx");
                        App.ui.showToast('Exportado a Excel', 'success');
                    },

                    toPdf() {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF({ orientation: 'landscape' });
                        
                        const headStyles = { fillColor: [68, 84, 106] }; // #44546A

                        doc.text("Listado Maestro de Documentación", 14, 15);
                        doc.autoTable({ 
                            startY: 20,
                            head: [['Producto', ...App.state.docKeys.flatMap(k => [`${k} Rev.`, `${k} Link`])]],
                            body: App.state.products.map(p => [p.name, ...App.state.docKeys.flatMap(k => [p.data[k]?.rev || '', p.data[k]?.link || ''])]),
                            headStyles: headStyles
                        });

                        doc.addPage();
                        doc.text("Historial de Cambios", 14, 15);
                        doc.autoTable({
                            startY: 20,
                            head: [['Fecha', 'Usuario', 'Producto', 'Documento', 'Antes', 'Después']],
                            body: App.state.history.map(h => [h.timestamp, h.usuario, h.producto, h.documento, h.antes, h.despues]),
                            headStyles: headStyles
                        });
                        
                        doc.save("ListadoMaestro.pdf");
                        App.ui.showToast('Exportado a PDF', 'success');
                    }
                };
            }
        };

        App.init();
    });
    </script>
    </div>
    <script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js';

const firebaseConfig = {
  apiKey: "AIzaSyD4FopYX645rwDYGSQTdDV0VObqds6q34g",
  authDomain: "proyecto-barack-4f731.firebaseapp.com",
  projectId: "proyecto-barack-4f731",
  storageBucket: "proyecto-barack-4f731.firebasestorage.app",
  messagingSenderId: "730750717116",
  appId: "1:730750717116:web:1fbcab2cbb59e0d83454b9",
  measurementId: "G-GBDQJ80TX7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

const loader = document.getElementById('loader');
const pageContent = document.getElementById('page-content');
const linkListado = document.getElementById('linkListado');
const linkAmfe = document.getElementById('linkAmfe');

onAuthStateChanged(auth, (user) => {
  if (user) {
    loader.style.display = 'none';
    pageContent.classList.remove('hidden');
    if (linkListado) linkListado.href = 'listado-maestro.html';
    if (linkAmfe) linkAmfe.href = 'amfe.html';
  } else {
    window.location.href = 'login.html';
  }
});
    </script>
</body>
</html>
